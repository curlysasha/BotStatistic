<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</title>
  <!-- Bootstrap & Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">

  <!-- 1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body text-center">
      <h2>üìå –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
      <p>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: <strong>{{ stats.total_files }}</strong></p>
      <p>–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ –¥–µ–Ω—å: <strong>{{ stats.average_per_day }}</strong></p>
      <!-- üïí –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞ -->
      <p>üïí –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: <strong id="srvTime">{{ server_time }}</strong></p>
    </div>
  </div>

  <!-- 2. –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3 class="text-center">üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h3>
      <table class="table table-bordered text-center">
        <thead class="table-primary">
        <tr><th>–î–∞—Ç–∞ üìÖ</th><th>–§–∞–π–ª—ã üìÅ</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ üë•</th></tr>
        </thead>
        <tbody>
        {% for date, files_count, users_count in stats.last_7_days %}
          <tr>
            <td><a href="#" class="date-link" data-date="{{ date }}">{{ date }}</a></td>
            <td>{{ files_count }}</td>
            <td>{{ users_count }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 3. –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3 class="text-center">üåü –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
      <table class="table table-bordered text-center">
        <thead class="table-warning"><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–§–∞–π–ª–æ–≤</th></tr></thead>
        <tbody>
        {% for user, count in stats.top_users_week %}
          <tr><td>{{ user }}</td><td>{{ count }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 4. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—â–∏–π—Å—è –≥—Ä–∞—Ñ–∏–∫ –ù–µ–¥–µ–ª—è/–ú–µ—Å—è—Ü -->
  <div class="card shadow-sm mb-4">
    <div class="card-body text-center">
      <div class="btn-group mb-3">
        <button class="btn btn-outline-primary active" id="btnWeek">–ó–∞ –Ω–µ–¥–µ–ª—é</button>
        <button class="btn btn-outline-primary" id="btnMonth">–ó–∞ –º–µ—Å—è—Ü</button>
      </div>
      <canvas id="dynamicChart"></canvas>
    </div>
  </div>

  <!-- 5. –≠–∫—Å–ø–æ—Ä—Ç -->
  <div class="text-center py-4">
    <a href="/export" class="btn btn-success btn-lg">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
  </div>

</div><!-- /container -->

<!-- === Modal 24h === -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞ <span id="modalDate"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="dayChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* -------------- –î–ê–ù–ù–´–ï —Å —Å–µ—Ä–≤–µ—Ä–∞ -------------- */
const weeklyData = {
  labels: [{% for d,_,_ in stats.last_7_days %}'{{d}}',{% endfor %}],
  files : [{% for _,f,_ in stats.last_7_days %}{{f}},{% endfor %}],
  users : [{% for _,_,u in stats.last_7_days %}{{u}},{% endfor %}]
};
const monthlyData = {
  labels: [{% for d,_,_ in stats.last_30_days %}'{{d}}',{% endfor %}],
  files : [{% for _,f,_ in stats.last_30_days %}{{f}},{% endfor %}],
  users : [{% for _,_,u in stats.last_30_days %}{{u}},{% endfor %}]
};

/* -------------- –ì–†–ê–§–ò–ö –ù–µ–¥–µ–ª—è/–ú–µ—Å—è—Ü -------------- */
let currentChart;
function renderChart(data, showUsers=true){
  if (currentChart) currentChart.destroy();
  currentChart = new Chart(document.getElementById('dynamicChart'), {
    type:'line',
    data:{
      labels:data.labels,
      datasets:[
        {label:'–§–∞–π–ª—ã',data:data.files,
         borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.2)',
         tension:0.3,fill:true},
        ...(showUsers?[{label:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',data:data.users,
         borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.2)',
         tension:0.3,fill:true}]:[])
      ]
    },
    options:{
      responsive:true,
      plugins:{title:{display:true,text:'üìà –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫',font:{size:16}}},
      scales:{x:{ticks:{maxRotation:45,minRotation:45}},y:{beginAtZero:true}}
    }
  });
}
document.getElementById('btnWeek').onclick = ()=>{
  renderChart(weeklyData,true);
  btnWeek.classList.add('active');btnMonth.classList.remove('active');
};
document.getElementById('btnMonth').onclick = ()=>{
  renderChart(monthlyData,false);
  btnMonth.classList.add('active');btnWeek.classList.remove('active');
};
renderChart(weeklyData,true);
setTimeout(()=>location.reload(),300000); // –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω

/* -------------- –ì–†–ê–§–ò–ö ¬´24 —á–∞—Å–∞¬ª -------------- */
function renderDayChart(hours){
  if (window.dayChartInstance) window.dayChartInstance.destroy();
  window.dayChartInstance = new Chart(document.getElementById('dayChart'),{
    type:'line',
    data:{
      labels:Array.from({length:24},(_,h)=>String(h).padStart(2,'0')+':00'),
      datasets:[{label:'–§–∞–π–ª—ã',data:hours,
        borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.2)',
        tension:0.3,fill:true}]
    },
    options:{
      responsive:true,
      plugins:{title:{display:true,text:'üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º',font:{size:16}}},
      scales:{x:{ticks:{maxRotation:45,minRotation:45}},y:{beginAtZero:true}}
    }
  });
}
document.querySelectorAll('.date-link').forEach(el=>{
  el.addEventListener('click',e=>{
    e.preventDefault();
    const date=el.dataset.date;
    fetch('/day/'+date)
      .then(r=>r.json())
      .then(d=>{
        document.getElementById('modalDate').textContent=date;
        renderDayChart(d.hourly);
        new bootstrap.Modal(document.getElementById('dayModal')).show();
      });
  });
});

/* -------------- –ê–í–¢–û-–û–ë–ù–û–í–õ–ï–ù–ò–ï –í–†–ï–ú–ï–ù–ò –°–ï–†–í–ï–†–ê -------------- */
setInterval(()=>{
  fetch('/server_time')
    .then(r=>r.json())
    .then(d=>{ document.getElementById('srvTime').textContent=d.now;});
},50000); // –∫–∞–∂–¥—ã–µ 50 —Å–µ–∫—É–Ω–¥
</script>

<style>
.btn.active{background-color:#3b82f6!important;color:white!important;}
</style>
</body>
</html>

