<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</title>

  <!-- Bootstrap 5 –∏ Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">

  <!-- 1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body text-center">
      <h2>üìå –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
      <p>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: <strong>{{ stats.total_files }}</strong></p>
      <p>–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ –¥–µ–Ω—å: <strong>{{ stats.average_per_day }}</strong></p>
      <p>üïí –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: <strong id="srvTime">{{ server_time }}</strong></p>
    </div>
  </div>

  <!-- 2. –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3 class="text-center">üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h3>
      <table class="table table-bordered text-center">
        <thead class="table-primary">
          <tr><th>–î–∞—Ç–∞ üìÖ</th><th>–§–∞–π–ª—ã üìÅ</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ üë•</th></tr>
        </thead>
        <tbody>
        {% for date, files_count, users_count in stats.last_7_days %}
          <tr>
            <td><a href="#" class="date-link" data-date="{{ date }}">{{ date }}</a></td>
            <td>{{ files_count }}</td>
            <td>{{ users_count }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 3. –¢–æ–ø-10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3 class="text-center">üåü –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
      <table class="table table-bordered text-center">
        <thead class="table-warning"><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–§–∞–π–ª–æ–≤</th></tr></thead>
        <tbody>
        {% for user, count in stats.top_users_week %}
          <tr><td>{{ user }}</td><td>{{ count }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 4. –ì—Ä–∞—Ñ–∏–∫ –ù–µ–¥–µ–ª—è / –ú–µ—Å—è—Ü -->
  <div class="card shadow-sm mb-4">
    <div class="card-body text-center">
      <div class="btn-group mb-3">
        <button class="btn btn-outline-primary active" id="btnWeek">–ó–∞ –Ω–µ–¥–µ–ª—é</button>
        <button class="btn btn-outline-primary" id="btnMonth">–ó–∞ –º–µ—Å—è—Ü</button>
      </div>
      <canvas id="dynamicChart"></canvas>
    </div>
  </div>

  <!-- 5. –≠–∫—Å–ø–æ—Ä—Ç -->
  <div class="text-center py-4">
    <a href="/export" class="btn btn-success btn-lg">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
  </div>
</div> <!-- /container -->

<!-- === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ 24 —á–∞—Å–∞ === -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞ <span id="modalDate"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="dayChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------------- –î–ê–ù–ù–´–ï —Å —Å–µ—Ä–≤–µ—Ä–∞ ---------------- */
const weeklyData = {
  labels:[{% for d,_,_ in stats.last_7_days %}'{{d}}',{% endfor %}],
  files :[{% for _,f,_ in stats.last_7_days %}{{f}},{% endfor %}],
  users :[{% for _,_,u in stats.last_7_days %}{{u}},{% endfor %}]
};
const monthlyData = {
  labels:[{% for d,_,_ in stats.last_30_days %}'{{d}}',{% endfor %}],
  files :[{% for _,f,_ in stats.last_30_days %}{{f}},{% endfor %}],
  users :[{% for _,_,u in stats.last_30_days %}{{u}},{% endfor %}]
};

/* --------------- –ì—Ä–∞—Ñ–∏–∫ –ù–µ–¥–µ–ª—è / –ú–µ—Å—è—Ü --------------- */
let currentChart;
function renderChart(data,showUsers=true){
  if(currentChart) currentChart.destroy();
  currentChart = new Chart(document.getElementById('dynamicChart'),{
    type:'line',
    data:{
      labels:data.labels,
      datasets:[
        {label:'–§–∞–π–ª—ã',data:data.files,
         borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.2)',
         tension:0.3,fill:true},
        ...(showUsers?[{label:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',data:data.users,
         borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.2)',
         tension:0.3,fill:true}]:[])
      ]
    },
    options:{responsive:true,
      plugins:{title:{display:true,text:'üìà –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫',font:{size:16}}},
      scales:{x:{ticks:{maxRotation:45,minRotation:45}},y:{beginAtZero:true}}
    }
  });
}
document.getElementById('btnWeek').onclick = ()=>{
  renderChart(weeklyData,true);
  btnWeek.classList.add('active'); btnMonth.classList.remove('active');
};
document.getElementById('btnMonth').onclick = ()=>{
  renderChart(monthlyData,false);
  btnMonth.classList.add('active'); btnWeek.classList.remove('active');
};
renderChart(weeklyData,true);

/* ----------- –ê–≤—Ç–æ-–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (15 –º–∏–Ω) ----------- */
setTimeout(()=>location.reload(), 900000);

/* ---------------- –ì—Ä–∞—Ñ–∏–∫ ¬´24 —á–∞—Å–∞¬ª ---------------- */
let dayChartInstance, dayRefreshTimer=null;

function renderDayChart(hours){
  if(dayChartInstance) dayChartInstance.destroy();
  dayChartInstance = new Chart(document.getElementById('dayChart'),{
    type:'line',
    data:{
      labels:Array.from({length:24},(_,h)=>String(h).padStart(2,'0')+':00'),
      datasets:[{label:'–§–∞–π–ª—ã',data:hours,
        borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.2)',
        tension:0.3,fill:true}]
    },
    options:{responsive:true,
      plugins:{title:{display:true,text:'üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º',font:{size:16}}},
      scales:{y:{beginAtZero:true}}
    }
  });
}

function refreshDayChart(date){
  fetch('/day/'+date)
    .then(r=>r.json())
    .then(d=>{
      dayChartInstance.data.datasets[0].data = d.hourly;
      dayChartInstance.update();
    });
}

document.querySelectorAll('.date-link').forEach(el=>{
  el.addEventListener('click',e=>{
    e.preventDefault();
    const date = el.dataset.date;
    fetch('/day/'+date)
      .then(r=>r.json())
      .then(d=>{
        document.getElementById('modalDate').textContent = date;
        renderDayChart(d.hourly);

        /* –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è */
        if(date === new Date().toISOString().slice(0,10)){
          dayRefreshTimer = setInterval(()=>refreshDayChart(date), 60000); // 1 –º–∏–Ω
        }
        new bootstrap.Modal(document.getElementById('dayModal')).show();
      });
  });
});

/* —á–∏—Å—Ç–∏–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ */
document.getElementById('dayModal')
  .addEventListener('hidden.bs.modal',()=>{
    if(dayRefreshTimer){ clearInterval(dayRefreshTimer); dayRefreshTimer=null; }
  });

/* --------- –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ ¬´–í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞¬ª --------- */
setInterval(()=>{
  fetch('/server_time')
    .then(r=>r.json())
    .then(d=>{ document.getElementById('srvTime').textContent = d.now; });
},60000);  // 60 —Å
</script>

<style>
.btn.active{background-color:#3b82f6!important;color:white!important;}
</style>
</body>
</html>

