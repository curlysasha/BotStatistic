<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</title>

  <!-- Bootstrap 5 –∏ Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="dashboard-container">

  <header class="dashboard-header">
    <h1>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</h1>
    <p class="server-time">üïí –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: <strong id="srvTime">{{ server_time }}</strong></p>
  </header>

  <section class="neo-card kpi-grid">
    <div class="kpi-item">
      <h2>üìå –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</h2>
      <p>{{ stats.total_files }}</p>
    </div>
    <div class="kpi-item">
      <h2>üìä –°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</h2>
      <p>{{ stats.average_per_day }}</p>
    </div>
    <div class="kpi-item">
      <h2>üë• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
      <p>{{ stats.unique_users_count_in_range | default('0') }}</p>
    </div>
    <div class="kpi-item">
      <h2>üîÑ –û–±—â–µ–µ —á–∏—Å–ª–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
      <p>{{ stats.total_user_interactions_in_range | default('0') }}</p>
    </div>
  </section>

  <section class="neo-card date-filters">
    <h3 class="neo-card-title">–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</h3>
    <div class="filter-controls">
      <div class="filter-group">
        <label for="startDateInput">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
        <input type="date" id="startDateInput" class="neo-input" value="{{ current_start_date if current_start_date else '' }}">
      </div>
      <div class="filter-group">
        <label for="endDateInput">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
        <input type="date" id="endDateInput" class="neo-input" value="{{ current_end_date if current_end_date else '' }}">
      </div>
      <div class="filter-buttons">
        <button class="neo-button" id="applyDateFilterBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="neo-button" id="btnLast7Days">7 –¥–Ω–µ–π</button>
        <button class="neo-button" id="btnLast14Days">14 –¥–Ω–µ–π</button> 
        <button class="neo-button" id="btnThisMonth">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</button>
        <button class="neo-button" id="btnAllTime">–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</button>
      </div>
    </div>
  </section>

  <section class="neo-card chart-container">
    <!-- Title will be set by Chart.js options -->
    <canvas id="dynamicChart"></canvas>
  </section>

  <div class="activity-patterns-grid">
    <div class="neo-card">
      <div class="neo-card-header">
        <h4>üïí Hourly Activity Distribution</h4>
      </div>
      <div class="neo-card-body chart-body-fixed-height">
        <canvas id="hourlyActivityChart"></canvas>
      </div>
    </div>
    <div class="neo-card">
      <div class="neo-card-header">
        <h4>üóìÔ∏è Day-of-Week Activity</h4>
      </div>
      <div class="neo-card-body chart-body-fixed-height">
        <canvas id="dayOfWeekActivityChart"></canvas>
      </div>
    </div>
  </div>

  <section class="neo-card" id="userDeepDiveCard">
    <h3 class="neo-card-title">üîç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")</h3>
    <!-- User selection controls removed -->
    <div id="userStatsDisplayArea" style="display: none; margin-top: 20px;">
      <div class="neo-card-header" style="margin-bottom: 10px; padding-bottom: 10px;"> 
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è <span id="selectedUserName" style="color: var(--primary-color);">N/A</span></h4>
      </div>
      <p class="user-kpi">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥: <strong id="userTotalFiles">0</strong></p>
      
      <div class="user-charts-grid">
        <div class="neo-card chart-body-fixed-height"> 
           <div class="neo-card-header" style="padding-bottom: 10px; margin-bottom:10px; border-bottom: none;">
             <h5 style="font-size: 1em; color: var(--text-light); margin:0;">Daily Trend</h5>
           </div>
          <canvas id="userDailyTrendChart"></canvas>
        </div>
        <div class="neo-card chart-body-fixed-height">
           <div class="neo-card-header" style="padding-bottom: 10px; margin-bottom:10px; border-bottom: none;">
             <h5 style="font-size: 1em; color: var(--text-light); margin:0;">Hourly Activity</h5>
           </div>
          <canvas id="userHourlyActivityChart"></canvas>
        </div>
        <div class="neo-card chart-body-fixed-height">
            <div class="neo-card-header" style="padding-bottom: 10px; margin-bottom:10px; border-bottom: none;">
             <h5 style="font-size: 1em; color: var(--text-light); margin:0;">Day of Week Activity</h5>
           </div>
          <canvas id="userDayOfWeekActivityChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <div class="tables-grid">
    <section class="neo-card">
      <h3 class="neo-card-title">üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h3>
      <div class="table-responsive">
        <table class="neo-table">
          <thead>
            <tr><th>–î–∞—Ç–∞ üìÖ</th><th>–§–∞–π–ª—ã üìÅ</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ üë•</th></tr>
          </thead>
          <tbody>
          {% for date, files_count, users_count in stats.last_7_days %}
            <tr>
              <td><a href="#" class="neo-link date-link" data-date="{{ date }}">{{ date }}</a></td>
              <td>{{ files_count }}</td>
              <td>{{ users_count }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="neo-card">
      <h3 class="neo-card-title">üåü –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ({{ stats.effective_start_date | default('N/A') }} - {{ stats.effective_end_date | default('N/A') }})</h3>
      <div class="table-responsive">
        <table class="neo-table">
          <thead><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–§–∞–π–ª–æ–≤</th></tr></thead>
          <tbody>
          {% for user, count in stats.top_users_in_range %}
            <tr><td><a href="#" class="user-link neo-link" data-user-id="{{ user }}">{{ user }}</a></td><td>{{ count }}</td></tr>
          {% else %}
            <tr><td colspan="2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>
  
  <footer class="dashboard-footer">
    <a href="/export?start_date={{current_start_date | default('')}}&end_date={{current_end_date | default('')}}" class="neo-button export-button">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
  </footer>

</div> <!-- /dashboard-container -->

<!-- === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ 24 —á–∞—Å–∞ === -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="neo-card modal-content-neo">
      <div class="modal-header-neo">
        <h5 class="modal-title-neo">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞ <span id="modalDate"></span></h5>
        <button type="button" class="neo-close-button" data-bs-dismiss="modal" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body-neo">
        <canvas id="dayChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS (needed for Modal) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------------- –î–ê–ù–ù–´–ï —Å —Å–µ—Ä–≤–µ—Ä–∞ ---------------- */
const dailyStats = {{ stats.daily | tojson }};
const dailyUserStats = {{ stats.daily_user_counts | tojson }};
const dailyNewUserStats = {{ stats.new_unique_users_per_day | default('[]') | tojson }};
const hourlyDistribution = {{ stats.hourly_distribution | tojson }};
const dayOfWeekDistribution = {{ stats.day_of_week_distribution | tojson }};
// const allUserActivityList = {{ stats.all_user_activity_list | default('[]') | tojson }}; // No longer needed for dropdown
const currentStartDate = "{{ current_start_date if current_start_date else '' }}";
const currentEndDate = "{{ current_end_date if current_end_date else '' }}";
const chartFont = "'Inter', sans-serif";
const primaryColor = '#3b82f6'; // Blue
const secondaryColor = '#ef4444'; // Red
const tertiaryColor = '#10b981'; // Green for new users
const textColor = '#374151'; // Dark gray for text
const gridColor = 'rgba(209, 213, 219, 0.5)'; // Light gray for grids
const chartTitleColor = '#1f2937'; // Even darker for titles

/* --------------- –ì—Ä–∞—Ñ–∏–∫ –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ --------------- */
let currentChart;
function renderChart(dailyData, dailyUserData, dailyNewUserData, titleText = '–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫') {
  if (currentChart) currentChart.destroy();
  
  const labels = dailyData.map(item => item[0]);
  const filesData = dailyData.map(item => item[1]);
  const usersData = dailyUserData.map(item => item[1]);
  const newUsersData = dailyNewUserData.map(item => item[1]);

  const datasets = [
    {
      label: '–§–∞–π–ª—ã',
      data: filesData,
      borderColor: primaryColor,
      backgroundColor: 'rgba(59,130,246,0.1)', 
      tension: 0.4, 
      fill: true,
      pointBackgroundColor: primaryColor,
      pointBorderColor: '#fff',
      pointHoverBackgroundColor: '#fff',
      pointHoverBorderColor: primaryColor,
      pointHoverRadius: 7,
      pointHoverBorderWidth: 2,
      pointRadius: 5
    }
  ];

  if (usersData && usersData.length > 0 && usersData.some(u => u > 0)) {
    datasets.push({
      label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', // Changed label for clarity
      data: usersData,
      borderColor: secondaryColor,
      backgroundColor: 'rgba(239,68,68,0.1)', 
      tension: 0.4,
      fill: true,
      pointBackgroundColor: secondaryColor,
      pointBorderColor: '#fff',
      pointHoverBackgroundColor: '#fff',
      pointHoverBorderColor: secondaryColor,
      pointHoverRadius: 7,
      pointHoverBorderWidth: 2,
      pointRadius: 5
    });
  }

  if (newUsersData && newUsersData.length > 0 && newUsersData.some(u => u > 0)) {
    datasets.push({
      label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
      data: newUsersData,
      borderColor: tertiaryColor, 
      backgroundColor: 'rgba(16, 185, 129, 0.1)',
      tension: 0.4,
      fill: true,
      pointBackgroundColor: tertiaryColor,
      pointBorderColor: '#fff',
      pointHoverBackgroundColor: '#fff',
      pointHoverBorderColor: tertiaryColor,
      pointHoverRadius: 7,
      pointHoverBorderWidth: 2,
      pointRadius: 5,
      yAxisID: 'y' // Ensure it uses the primary y-axis if not specified otherwise
    });
  }


  currentChart = new Chart(document.getElementById('dynamicChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: titleText, font: { size: 18, family: chartFont, weight: '600' }, color: chartTitleColor, padding: { top:10, bottom: 20 } },
        legend: { 
            display: datasets.length > 1,
            position: 'bottom',
            labels: { font: { family: chartFont, size: 14 }, color: textColor, usePointStyle: true, pointStyle: 'circle', padding: 20, boxWidth: 8 }
        },
        tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleFont: { family: chartFont, size: 14, weight: '600' },
            bodyFont: { family: chartFont, size: 12 },
            padding: 12,
            cornerRadius: 8,
            displayColors: true,
            boxPadding: 4,
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1
        }
      },
      scales: {
        x: { 
            ticks: { maxRotation: 45, minRotation: 20, font: { family: chartFont, size: 12 }, color: textColor },
            grid: { display: false } 
        },
        y: { 
            beginAtZero: true,
            type: 'linear', // Primary y-axis
            position: 'left',
            ticks: { font: { family: chartFont, size: 12 }, color: textColor, padding: 10 },
            grid: { color: gridColor, drawBorder: false }
        }
      },
      layout: {
        padding: { left: 0, right: 10, top: 0, bottom: 0 } 
      },
      interaction: {
        intersect: false,
        mode: 'index',
      }
    }
  });
}

renderChart(dailyStats, dailyUserStats, dailyNewUserStats, 
    `–î–∏–Ω–∞–º–∏–∫–∞ —Å ${currentStartDate || '–Ω–∞—á–∞–ª–∞'} –ø–æ ${currentEndDate || '–∫–æ–Ω–µ—Ü'}`);

/* --------------- Hourly Activity Chart --------------- */
function renderHourlyActivityChart() {
  const hourlyLabels = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);
  new Chart(document.getElementById('hourlyActivityChart'), {
    type: 'bar',
    data: {
      labels: hourlyLabels,
      datasets: [{
        label: '–§–∞–π–ª–æ–≤ –≤ —á–∞—Å',
        data: hourlyDistribution,
        backgroundColor: 'rgba(59, 130, 246, 0.6)', // primaryColor with some opacity
        borderColor: primaryColor,
        borderWidth: 1,
        borderRadius: 5,
        hoverBackgroundColor: 'rgba(59, 130, 246, 0.8)',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: false }, // Title is in neo-card-header
        legend: { display: false },
        tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleFont: { family: chartFont, size: 13, weight: '600' },
            bodyFont: { family: chartFont, size: 11 },
            padding: 10,
            cornerRadius: 6,
            displayColors: false
        }
      },
      scales: {
        x: { ticks: { font: { family: chartFont, size: 10 }, color: textColor }, grid: { display: false } },
        y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { color: gridColor, drawBorder: false } }
      }
    }
  });
}

/* --------------- Day-of-Week Activity Chart --------------- */
function renderDayOfWeekActivityChart() {
  const dowLabels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  new Chart(document.getElementById('dayOfWeekActivityChart'), {
    type: 'bar',
    data: {
      labels: dowLabels,
      datasets: [{
        label: '–§–∞–π–ª–æ–≤ –∑–∞ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏',
        data: dayOfWeekDistribution,
        backgroundColor: 'rgba(239, 68, 68, 0.6)', // secondaryColor with some opacity
        borderColor: secondaryColor,
        borderWidth: 1,
        borderRadius: 5,
        hoverBackgroundColor: 'rgba(239, 68, 68, 0.8)',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: false }, // Title is in neo-card-header
        legend: { display: false },
         tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleFont: { family: chartFont, size: 13, weight: '600' },
            bodyFont: { family: chartFont, size: 11 },
            padding: 10,
            cornerRadius: 6,
            displayColors: false
        }
      },
      scales: {
        x: { ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { display: false } },
        y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { color: gridColor, drawBorder: false } }
      }
    }
  });
}

// Render all charts on load
if (document.getElementById('hourlyActivityChart')) renderHourlyActivityChart();
if (document.getElementById('dayOfWeekActivityChart')) renderDayOfWeekActivityChart();

/* ----------- Populate User Selector (No longer needed) ----------- */
// const userSelect = document.getElementById('userStatsSelect');
// if (userSelect && typeof allUserActivityList !== 'undefined' && allUserActivityList && allUserActivityList.length > 0) {
//     allUserActivityList.forEach(userData => { 
//         const option = new Option(`${userData[0]} (${userData[1]} files)`, userData[0]);
//         userSelect.add(option);
//     });
// } else if (userSelect) { 
//     const option = new Option('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞', '');
//     option.disabled = true;
//     userSelect.add(option);
//     const viewUserStatsBtn = document.getElementById('viewUserStatsBtn');
//     if (viewUserStatsBtn) viewUserStatsBtn.disabled = true;
//     userSelect.disabled = true;
// }

/* ----------- User Specific Stats Chart Instances ----------- */
let userDailyTrendChartInstance = null;
let userHourlyActivityChartInstance = null;
let userDayOfWeekActivityChartInstance = null;

/* ----------- Render User Specific Charts ----------- */
function renderUserDailyTrendChart(dailyActivity) {
    if (userDailyTrendChartInstance) userDailyTrendChartInstance.destroy();
    const labels = dailyActivity.map(item => item[0]);
    const data = dailyActivity.map(item => item[1]);
    userDailyTrendChartInstance = new Chart(document.getElementById('userDailyTrendChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–§–∞–π–ª–æ–≤ –≤ –¥–µ–Ω—å',
                data: data,
                borderColor: primaryColor,
                backgroundColor: 'rgba(59,130,246,0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: primaryColor,
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: primaryColor,
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { font: { family: chartFont, size: 10 }, color: textColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { color: gridColor, drawBorder: false } } } }
    });
}

function renderUserHourlyActivityChart(hourlyData) {
    if (userHourlyActivityChartInstance) userHourlyActivityChartInstance.destroy();
    const hourlyLabels = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);
    userHourlyActivityChartInstance = new Chart(document.getElementById('userHourlyActivityChart'), {
        type: 'bar',
        data: {
            labels: hourlyLabels,
            datasets: [{
                label: '–§–∞–π–ª–æ–≤ –≤ —á–∞—Å',
                data: hourlyData,
                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                borderColor: primaryColor,
                borderWidth: 1,
                borderRadius: 5,
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { font: { family: chartFont, size: 10 }, color: textColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { color: gridColor, drawBorder: false } } } }
    });
}

function renderUserDayOfWeekActivityChart(dowData) {
    if (userDayOfWeekActivityChartInstance) userDayOfWeekActivityChartInstance.destroy();
    const dowLabels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    userDayOfWeekActivityChartInstance = new Chart(document.getElementById('userDayOfWeekActivityChart'), {
        type: 'bar',
        data: {
            labels: dowLabels,
            datasets: [{
                label: '–§–∞–π–ª–æ–≤ –∑–∞ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏',
                data: dowData,
                backgroundColor: 'rgba(239, 68, 68, 0.6)',
                borderColor: secondaryColor,
                borderWidth: 1,
                borderRadius: 5,
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { color: gridColor, drawBorder: false } } } }
    });
}

/* ----------- Fetch and Display User Stats ----------- */
async function fetchAndDisplayUserStats(selectedUserId) { // Now accepts userId as argument
    if (!selectedUserId) {
        // This case should ideally not be reached if triggered by user-link click
        // but good for robustness if called from elsewhere.
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."); 
        document.getElementById('userStatsDisplayArea').style.display = 'none';
        return;
    }

    const startDate = document.getElementById('startDateInput').value;
    const endDate = document.getElementById('endDateInput').value;
    
    let apiUrl = `/api/user_activity/${selectedUserId}`;
    const params = [];
    if (startDate) params.push(`start_date=${startDate}`);
    if (endDate) params.push(`end_date=${endDate}`);
    if (params.length > 0) apiUrl += '?' + params.join('&');

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const userData = await response.json();

        document.getElementById('selectedUserName').textContent = userData.user_id;
        document.getElementById('userTotalFiles').textContent = userData.total_files;

        renderUserDailyTrendChart(userData.daily_activity);
        renderUserHourlyActivityChart(userData.hourly_distribution);
        renderUserDayOfWeekActivityChart(userData.day_of_week_distribution);

        document.getElementById('userStatsDisplayArea').style.display = 'block';
        // Scroll to the user stats area
        document.getElementById('userDeepDiveCard').scrollIntoView({ behavior: 'smooth' });


    } catch (error) {
        console.error("Could not fetch user stats:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
        document.getElementById('userStatsDisplayArea').style.display = 'none';
    }
}

// Remove event listener for the old button
// const viewUserStatsBtn = document.getElementById('viewUserStatsBtn');
// if (viewUserStatsBtn) {
//     viewUserStatsBtn.addEventListener('click', () => {
//         const selectedUserId = document.getElementById('userStatsSelect').value;
//         fetchAndDisplayUserStats(selectedUserId);
//     });
// }

/* ----------- Event Listener for Clickable User IDs in Table ----------- */
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('user-link')) {
        event.preventDefault();
        const userId = event.target.dataset.userId;
        if (userId) {
            fetchAndDisplayUserStats(userId);
        }
    }
});


/* ----------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–∞—Ç ----------- */
document.getElementById('applyDateFilterBtn').addEventListener('click', () => {
  const startDate = document.getElementById('startDateInput').value;
  const endDate = document.getElementById('endDateInput').value;
  let url = '/';
  const params = [];
  if (startDate) params.push(`start_date=${startDate}`);
  if (endDate) params.push(`end_date=${endDate}`);
  if (params.length > 0) url += '?' + params.join('&');
  window.location.href = url;
});

function setDatesAndApply(daysAgoStart, daysAgoEnd = 0) {
    const today = new Date();
    const endDate = new Date(today);
    endDate.setDate(today.getDate() - daysAgoEnd);
    document.getElementById('endDateInput').value = endDate.toISOString().slice(0,10);

    const startDate = new Date(today);
    startDate.setDate(today.getDate() - daysAgoStart);
    document.getElementById('startDateInput').value = startDate.toISOString().slice(0,10);
    
    document.getElementById('applyDateFilterBtn').click();
}

document.getElementById('btnLast7Days').addEventListener('click', () => setDatesAndApply(6));
document.getElementById('btnLast14Days').addEventListener('click', () => setDatesAndApply(13)); 

document.getElementById('btnThisMonth').addEventListener('click', () => {
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    document.getElementById('startDateInput').value = firstDayOfMonth.toISOString().slice(0,10);
    document.getElementById('endDateInput').value = lastDayOfMonth.toISOString().slice(0,10);
    document.getElementById('applyDateFilterBtn').click();
});

document.getElementById('btnAllTime').addEventListener('click', () => {
  document.getElementById('startDateInput').value = '';
  document.getElementById('endDateInput').value = '';
  window.location.href = '/';
});

/* ----------- –ê–≤—Ç–æ-–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (15 –º–∏–Ω) ----------- */
setTimeout(()=>location.reload(), 900000);

/* ---------------- –ì—Ä–∞—Ñ–∏–∫ ¬´24 —á–∞—Å–∞¬ª –≤ –º–æ–¥–∞–ª–∫–µ ---------------- */
let dayChartInstance, dayRefreshTimer=null;

function renderDayChart(hours){
  if(dayChartInstance) dayChartInstance.destroy();
  dayChartInstance = new Chart(document.getElementById('dayChart'),{
    type:'line',
    data:{
      labels:Array.from({length:24},(_,h)=>String(h).padStart(2,'0')+':00'),
      datasets:[{
          label:'–§–∞–π–ª—ã',
          data:hours,
          borderColor: primaryColor,
          backgroundColor: 'rgba(59,130,246,0.1)',
          tension:0.4,
          fill:true,
          pointBackgroundColor: primaryColor,
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: primaryColor,
          pointHoverRadius: 6,
          pointHoverBorderWidth: 2,
          pointRadius: 4
      }]
    },
    options:{
        responsive:true,
        maintainAspectRatio: false,
        plugins:{
            title:{display:true,text:'üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º',font:{size:16, family: chartFont, weight: '600' }, color: chartTitleColor, padding: {bottom: 15}},
            legend: { display: false },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: { family: chartFont, size: 13, weight: '600' },
                bodyFont: { family: chartFont, size: 11 },
                padding: 10,
                cornerRadius: 6,
                displayColors: false
            }
        },
        scales:{
            y:{beginAtZero:true, ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { color: gridColor, drawBorder: false }},
            x:{ticks: { font: { family: chartFont, size: 11 }, color: textColor }, grid: { display: false }}
        },
        interaction: {
            intersect: false,
            mode: 'index',
        }
    }
  });
}

function refreshDayChart(date){
  fetch('/day/'+date)
    .then(r=>r.json())
    .then(d=>{
      if (dayChartInstance && d.hourly) {
        dayChartInstance.data.datasets[0].data = d.hourly;
        dayChartInstance.update();
      }
    });
}

document.querySelectorAll('.date-link').forEach(el=>{
  el.addEventListener('click',e=>{
    e.preventDefault();
    const date = el.dataset.date;
    fetch('/day/'+date)
      .then(r=>r.json())
      .then(d=>{
        if (d.error) { console.error("Error fetching day detail:", d.error); return; }
        document.getElementById('modalDate').textContent = date;
        renderDayChart(d.hourly);

        if(date === new Date().toISOString().slice(0,10)){
          if(dayRefreshTimer) clearInterval(dayRefreshTimer); 
          dayRefreshTimer = setInterval(()=>refreshDayChart(date), 60000);
        } else {
          if(dayRefreshTimer) clearInterval(dayRefreshTimer); 
        }
        
        let dayModalElement = document.getElementById('dayModal');
        let modalInstance = bootstrap.Modal.getInstance(dayModalElement);
        if (!modalInstance) {
            modalInstance = new bootstrap.Modal(dayModalElement);
        }
        modalInstance.show();
      });
  });
});

document.getElementById('dayModal')
  .addEventListener('hidden.bs.modal',()=>{
    if(dayRefreshTimer){ clearInterval(dayRefreshTimer); dayRefreshTimer=null; }
  });

setInterval(()=>{
  fetch('/server_time')
    .then(r=>r.json())
    .then(d=>{ 
        const srvTimeEl = document.getElementById('srvTime');
        if (srvTimeEl) srvTimeEl.textContent = d.now; 
    });
},60000);
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  --base-bg: #eef1f5; 
  --text-color: #374151; 
  --text-light: #6b7280; 
  --primary-color: #3b82f6; 
  --primary-darker: #2563eb; /* For active/pressed states */
  --shadow-light: #ffffff;
  --shadow-dark: #d1d5db; /* Slightly softer dark shadow */
  --neo-radius: 18px; /* Slightly reduced for a tighter look */
  --neo-padding: 20px; /* Slightly reduced padding */
  --chart-title-color: #1f2937;
  --shadow-offset: 6px; /* Main offset for extruded elements */
  --shadow-blur: 12px; /* Main blur for extruded elements */
  --inset-shadow-offset: 4px;
  --inset-shadow-blur: 8px;
}

.user-select-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 15px 20px;
  align-items: flex-end; 
  margin-bottom: 20px;
}
.user-select-controls .filter-group { 
    margin-bottom: 0; 
}
.user-select-controls .neo-input { 
    min-width: 250px; 
}

.user-kpi {
  font-size: 1.1em;
  text-align: center;
  margin: 15px 0;
  color: var(--text-color);
}
.user-kpi strong {
  color: var(--primary-color);
  font-weight: 600;
}
.user-charts-grid {
  display: grid;
  grid-template-columns: 1fr; 
  gap: var(--neo-padding);
}
#userDailyTrendChart, #userHourlyActivityChart, #userDayOfWeekActivityChart {
    width: 100% !important;
    height: 100% !important;
}


.neo-card-header {
  padding-bottom: 15px;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--shadow-dark);
  text-align: center;
}
.neo-card-header h4 {
  margin: 0;
  font-size: 1.2em; 
  font-weight: 600;
  color: var(--chart-title-color);
}
.neo-card-body {
  /* General body styles */
}
.chart-body-fixed-height {
  height: 320px; 
}


body {
  font-family: 'Inter', sans-serif;
  background-color: var(--base-bg);
  color: var(--text-color);
  margin: 0;
  padding: 20px; 
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.dashboard-container {
  display: flex;
  flex-direction: column;
  gap: 25px; 
  max-width: 1600px; 
  margin: auto; 
}

.dashboard-header {
  text-align: center;
  padding: 10px 0;
  margin-bottom: 10px;
}
.dashboard-header h1 {
  font-size: 2.2em;
  font-weight: 700;
  color: var(--chart-title-color);
  margin-bottom: 0.2em;
}
.server-time {
  font-size: 0.95em;
  color: var(--text-light);
}

.neo-card {
  background-color: var(--base-bg);
  border-radius: var(--neo-radius);
  padding: var(--neo-padding);
  box-shadow: var(--shadow-offset) var(--shadow-offset) var(--shadow-blur) var(--shadow-dark), 
              calc(-1 * var(--shadow-offset)) calc(-1 * var(--shadow-offset)) var(--shadow-blur) var(--shadow-light);
  transition: box-shadow 0.25s ease-in-out;
}
.neo-card-title {
  font-size: 1.4em;
  font-weight: 600;
  color: var(--chart-title-color);
  margin-bottom: 20px;
  text-align: center;
}

.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: var(--neo-padding);
}
.kpi-item {
  text-align: center;
  padding: 20px; 
  background-color: var(--base-bg); 
  border-radius: 15px; 
   box-shadow: inset var(--inset-shadow-offset) var(--inset-shadow-offset) var(--inset-shadow-blur) var(--shadow-dark), 
              inset calc(-1 * var(--inset-shadow-offset)) calc(-1 * var(--inset-shadow-offset)) var(--inset-shadow-blur) var(--shadow-light);
}
.kpi-item h2 {
  font-size: 1.05em; 
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  margin-bottom: 10px;
  font-weight: 600;
}
.kpi-item p {
  font-size: 2.1em;
  font-weight: 700;
  color: var(--primary-color);
  margin: 0;
}

.date-filters .filter-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 15px 20px; 
  align-items: flex-end;
  justify-content: center;
}
.filter-group {
  display: flex;
  flex-direction: column;
  flex-grow: 1; 
  min-width: 180px; 
}
.filter-group label {
  font-size: 0.85em;
  color: var(--text-light);
  margin-bottom: 6px;
  font-weight: 500;
}
.filter-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  padding-top: 22px; 
}

.neo-input {
  background-color: var(--base-bg);
  border: none;
  border-radius: 10px; 
  padding: 12px 18px;
  font-size: 1em;
  font-family: 'Inter', sans-serif;
  color: var(--text-color);
  box-shadow: inset var(--inset-shadow-offset) var(--inset-shadow-offset) var(--inset-shadow-blur) var(--shadow-dark), 
              inset calc(-1 * var(--inset-shadow-offset)) calc(-1 * var(--inset-shadow-offset)) var(--inset-shadow-blur) var(--shadow-light);
  transition: box-shadow 0.25s ease-in-out;
  outline: none;
  width: 100%; 
  box-sizing: border-box;
}
.neo-input:focus {
  box-shadow: inset calc(var(--inset-shadow-offset) + 2px) calc(var(--inset-shadow-offset) + 2px) calc(var(--inset-shadow-blur) + 4px) var(--shadow-dark), 
              inset calc(-1 * (var(--inset-shadow-offset) + 2px)) calc(-1 * (var(--inset-shadow-offset) + 2px)) calc(var(--inset-shadow-blur) + 4px) var(--shadow-light),
              0 0 0 2px var(--primary-color); 
}

.neo-button {
  background-color: var(--base-bg);
  color: var(--text-color);
  border: none;
  border-radius: 10px;
  padding: 11px 18px; 
  font-size: 0.9em;
  font-weight: 600; 
  cursor: pointer;
  box-shadow: var(--shadow-offset) var(--shadow-offset) var(--shadow-blur) var(--shadow-dark), 
              calc(-1 * var(--shadow-offset)) calc(-1 * var(--shadow-offset)) var(--shadow-blur) var(--shadow-light);
  transition: all 0.15s ease-in-out;
  text-decoration: none; 
  display: inline-block; 
}
.neo-button:hover {
  color: var(--primary-color);
  box-shadow: calc(var(--shadow-offset) + 2px) calc(var(--shadow-offset) + 2px) calc(var(--shadow-blur) + 4px) var(--shadow-dark), 
              calc(-1 * (var(--shadow-offset) + 2px)) calc(-1 * (var(--shadow-offset) + 2px)) calc(var(--shadow-blur) + 4px) var(--shadow-light);
}
.neo-button:active {
  box-shadow: inset var(--shadow-offset) var(--shadow-offset) var(--shadow-blur) var(--shadow-dark), 
              inset calc(-1 * var(--shadow-offset)) calc(-1 * var(--shadow-offset)) var(--shadow-blur) var(--shadow-light);
  color: var(--primary-darker);
}
.neo-button.export-button { 
    background-color: #28a745; 
    color: white;
    box-shadow: var(--shadow-offset) var(--shadow-offset) var(--shadow-blur) #1e7e34, 
                calc(-1 * var(--shadow-offset)) calc(-1 * var(--shadow-offset)) var(--shadow-blur) #32d056;
}
.neo-button.export-button:hover {
    background-color: #218838; 
    color: white;
    box-shadow: calc(var(--shadow-offset) + 2px) calc(var(--shadow-offset) + 2px) calc(var(--shadow-blur) + 4px) #1e7e34, 
                calc(-1 * (var(--shadow-offset) + 2px)) calc(-1 * (var(--shadow-offset) + 2px)) calc(var(--shadow-blur) + 4px) #32d056;
}
.neo-button.export-button:active {
    box-shadow: inset var(--shadow-offset) var(--shadow-offset) var(--shadow-blur) #1c6c2e, 
                inset calc(-1 * var(--shadow-offset)) calc(-1 * var(--shadow-offset)) var(--shadow-blur) #2db94d;
    color: #e0e0e0;
}


.chart-container { 
  height: 480px; 
  padding: var(--neo-padding);
}
#dynamicChart { 
  width: 100% !important;
  height: 100% !important;
}

.activity-patterns-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--neo-padding);
}
#hourlyActivityChart, #dayOfWeekActivityChart { 
  width: 100% !important;
  height: 100% !important;
}


.tables-grid {
  display: grid;
  grid-template-columns: 1fr 1fr; 
  gap: var(--neo-padding);
}
.table-responsive {
  overflow-x: auto; 
  border-radius: 15px; 
  padding: 10px; 
  background-color: var(--base-bg);
  box-shadow: inset var(--inset-shadow-offset) var(--inset-shadow-offset) var(--inset-shadow-blur) var(--shadow-dark), 
              inset calc(-1 * var(--inset-shadow-offset)) calc(-1 * var(--inset-shadow-offset)) var(--inset-shadow-blur) var(--shadow-light);
}
.neo-table {
  width: 100%;
  border-collapse: separate; 
  border-spacing: 0;
  font-size: 0.9em;
}
.neo-table th, .neo-table td {
  padding: 14px 16px; 
  text-align: left;
  border-bottom: 1px solid var(--shadow-dark); 
}
.neo-table th:first-child, .neo-table td:first-child { padding-left: 20px; }
.neo-table th:last-child, .neo-table td:last-child { padding-right: 20px; }

.neo-table thead tr {
    background-color: transparent; 
}
.neo-table th {
  font-weight: 600;
  color: var(--text-light);
  text-align: center;
  border-bottom-width: 2px; 
}
.neo-table td {
  text-align: center;
  color: var(--text-color);
}
.neo-table tbody tr:last-child td {
    border-bottom: none; 
}
.neo-table tbody tr:hover {
  background-color: rgba(222, 227, 233, 0.5); /* Slightly darker than base for hover */
}
.neo-link {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 500;
}
.neo-link:hover {
  color: var(--primary-darker);
  text-decoration: underline;
}

.dashboard-footer {
  text-align: center;
  padding-top: 20px;
}


.modal-backdrop.show {
    background-color: rgba(0,0,0,0.05); /* Very subtle backdrop */
    backdrop-filter: blur(2px); /* Softer blur */
    opacity: 1;
}
.modal-dialog { 
    max-width: 800px; 
}
.modal-content-neo {
  background-color: var(--base-bg);
  border-radius: var(--neo-radius);
  padding: var(--neo-padding);
  box-shadow: var(--shadow-offset) var(--shadow-offset) var(--shadow-blur) var(--shadow-dark), 
              calc(-1 * var(--shadow-offset)) calc(-1 * var(--shadow-offset)) var(--shadow-blur) var(--shadow-light);
  border: none; 
  text-align:center;
}
.modal-header-neo {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 15px;
  border-bottom: 1px solid var(--shadow-dark);
  margin-bottom: 20px;
}
.modal-title-neo {
  font-size: 1.5em;
  font-weight: 600;
  color: var(--chart-title-color);
}
.neo-close-button {
  background: transparent;
  border: none;
  font-size: 2.2em;
  line-height: 1;
  color: var(--text-light);
  cursor: pointer;
  padding: 0 5px;
  opacity: 0.8;
  transition: all 0.2s;
  border-radius: 8px;
}
.neo-close-button:hover {
  opacity: 1;
  color: var(--primary-color);
  background-color: rgba(222, 227, 233, 0.7); /* Light hover effect */
}
.modal-body-neo {
  padding: 0; 
  height: 400px; 
}
#dayChart {
  width: 100% !important;
  height: 100% !important;
}


/* Responsiveness */
@media (max-width: 1200px) {
  .kpi-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
}

@media (max-width: 992px) {
  .user-charts-grid, 
  .activity-patterns-grid,
  .tables-grid {
    grid-template-columns: 1fr; 
  }
  .date-filters .filter-controls {
    flex-direction: column;
    align-items: stretch;
  }
  .filter-buttons {
    justify-content: flex-start;
    padding-top: 10px;
  }
   .filter-buttons .neo-button {
    flex-grow: 1; 
  }
  .dashboard-header h1 {
    font-size: 1.9em;
  }
}

@media (max-width: 768px) {
  body { padding: 15px; }
  .dashboard-container { gap: 20px; }
  :root {
    --neo-radius: 16px; /* Slightly smaller overall */
    --neo-padding: 18px;
    --shadow-offset: 5px; 
    --shadow-blur: 10px; 
    --inset-shadow-offset: 3px;
    --inset-shadow-blur: 6px;
  }
  .neo-card-title { font-size: 1.25em; }
  .kpi-item p { font-size: 1.8em; }
  .neo-button, .neo-input { padding: 12px 16px; font-size: 0.9em;}
  
  .filter-buttons {
     flex-direction: row; 
  }
   .filter-buttons .neo-button {
      flex-basis: calc(50% - 5px); 
  }

  .modal-dialog {
      margin: 15px; 
      max-width: calc(100% - 30px);
  }
  .modal-body-neo {
      height: 320px; 
  }
  .dashboard-header h1 {
    font-size: 1.7em;
  }
}

@media (max-width: 480px) {
    .dashboard-header h1 { font-size: 1.4em; }
    :root {
        --neo-radius: 12px;
        --neo-padding: 15px;
        --shadow-offset: 4px; 
        --shadow-blur: 8px; 
        --inset-shadow-offset: 2px;
        --inset-shadow-blur: 4px;
    }
    .kpi-grid {
        grid-template-columns: 1fr; 
    }
    .filter-buttons .neo-button {
      flex-basis: 100%; 
    }
    .neo-table { font-size: 0.85em; }
    .neo-table th, .neo-table td { padding: 10px 12px; }
    .chart-container { height: 350px; }
    .chart-body-fixed-height { height: 280px; } 
    .user-charts-grid .chart-body-fixed-height { height: 260px; } 
    .modal-body-neo { height: 280px; }
}

@media (min-width: 993px) { 
    .user-charts-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

</style>
</body>
</html>
