<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</title>

  <!-- Bootstrap 5 –∏ Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="dashboard-container">

  <header class="dashboard-header">
    <h1>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</h1>
    <p class="server-time">üïí –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: <strong id="srvTime">{{ server_time }}</strong></p>
  </header>

  <section class="neo-card kpi-grid">
    <div class="kpi-item">
      <h2>üìå –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</h2>
      <p>{{ stats.total_files }}</p>
    </div>
    <div class="kpi-item">
      <h2>üìä –°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</h2>
      <p>{{ stats.average_per_day }}</p>
    </div>
    <div class="kpi-item">
      <h2>üë• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
      <p>{{ stats.unique_users_count_in_range | default('0') }}</p>
    </div>
    <div class="kpi-item">
      <h2>üîÑ –û–±—â–µ–µ —á–∏—Å–ª–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
      <p>{{ stats.total_user_interactions_in_range | default('0') }}</p>
    </div>
  </section>

  <section class="neo-card date-filters">
    <h3 class="neo-card-title">–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</h3>
    <div class="filter-controls">
      <div class="filter-group">
        <label for="startDateInput">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
        <input type="date" id="startDateInput" class="neo-input" value="{{ current_start_date if current_start_date else '' }}">
      </div>
      <div class="filter-group">
        <label for="endDateInput">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
        <input type="date" id="endDateInput" class="neo-input" value="{{ current_end_date if current_end_date else '' }}">
      </div>
      <div class="filter-buttons">
        <button class="neo-button" id="applyDateFilterBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="neo-button" id="btnLast7Days">7 –¥–Ω–µ–π</button>
        <button class="neo-button" id="btnLast14Days">14 –¥–Ω–µ–π</button> 
        <button class="neo-button" id="btnThisMonth">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</button>
        <button class="neo-button" id="btnAllTime">–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</button>
      </div>
    </div>
  </section>

  <section class="neo-card chart-container">
    <!-- Title will be set by Chart.js options -->
    <canvas id="dynamicChart"></canvas>
  </section>

  <div class="activity-patterns-grid">
    <div class="neo-card">
      <div class="neo-card-header">
        <h4>üïí Hourly Activity Distribution</h4>
      </div>
      <div class="neo-card-body chart-body-fixed-height">
        <canvas id="hourlyActivityChart"></canvas>
      </div>
    </div>
    <div class="neo-card">
      <div class="neo-card-header">
        <h4>üóìÔ∏è Day-of-Week Activity</h4>
      </div>
      <div class="neo-card-body chart-body-fixed-height">
        <canvas id="dayOfWeekActivityChart"></canvas>
      </div>
    </div>
  </div>

  <section class="neo-card" id="userDeepDiveCard">
    <h3 class="neo-card-title">üîç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")</h3>
    <!-- User selection controls removed -->
    <div id="userStatsDisplayArea" style="display: none; margin-top: 20px;">
      <div class="neo-card-header" style="margin-bottom: 10px; padding-bottom: 10px;"> 
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è <span id="selectedUserName" style="color: var(--primary-color-accent);">N/A</span></h4>
      </div>
      <p class="user-kpi">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥: <strong id="userTotalFiles">0</strong></p>
      
      <div class="user-charts-grid">
        <div class="neo-card chart-body-fixed-height"> 
           <div class="neo-card-header" style="padding-bottom: 10px; margin-bottom:10px; border-bottom: none;">
             <h5 style="font-size: 1em; color: var(--text-light-on-glass); margin:0;">Daily Trend</h5>
           </div>
          <canvas id="userDailyTrendChart"></canvas>
        </div>
        <div class="neo-card chart-body-fixed-height">
           <div class="neo-card-header" style="padding-bottom: 10px; margin-bottom:10px; border-bottom: none;">
             <h5 style="font-size: 1em; color: var(--text-light-on-glass); margin:0;">Hourly Activity</h5>
           </div>
          <canvas id="userHourlyActivityChart"></canvas>
        </div>
        <div class="neo-card chart-body-fixed-height">
            <div class="neo-card-header" style="padding-bottom: 10px; margin-bottom:10px; border-bottom: none;">
             <h5 style="font-size: 1em; color: var(--text-light-on-glass); margin:0;">Day of Week Activity</h5>
           </div>
          <canvas id="userDayOfWeekActivityChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <div class="tables-grid">
    <section class="neo-card">
      <h3 class="neo-card-title">üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h3>
      <div class="table-responsive">
        <table class="neo-table">
          <thead>
            <tr><th>–î–∞—Ç–∞ üìÖ</th><th>–§–∞–π–ª—ã üìÅ</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ üë•</th></tr>
          </thead>
          <tbody>
          {% for date, files_count, users_count in stats.last_7_days %}
            <tr>
              <td><a href="#" class="neo-link date-link" data-date="{{ date }}">{{ date }}</a></td>
              <td>{{ files_count }}</td>
              <td>{{ users_count }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="neo-card">
      <h3 class="neo-card-title">üåü –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ({{ stats.effective_start_date | default('N/A') }} - {{ stats.effective_end_date | default('N/A') }})</h3>
      <div class="table-responsive">
        <table class="neo-table">
          <thead><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–§–∞–π–ª–æ–≤</th></tr></thead>
          <tbody>
          {% for user, count in stats.top_users_in_range %}
            <tr><td><a href="#" class="user-link neo-link" data-user-id="{{ user }}">{{ user }}</a></td><td>{{ count }}</td></tr>
          {% else %}
            <tr><td colspan="2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>
  
  <footer class="dashboard-footer">
    <a href="/export?start_date={{current_start_date | default('')}}&end_date={{current_end_date | default('')}}" class="neo-button export-button">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
  </footer>

</div> <!-- /dashboard-container -->

<!-- === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ 24 —á–∞—Å–∞ === -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="neo-card modal-content-neo"> <!-- Applied .neo-card for glass effect -->
      <div class="modal-header-neo">
        <h5 class="modal-title-neo">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞ <span id="modalDate"></span></h5>
        <button type="button" class="neo-close-button" data-bs-dismiss="modal" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body-neo">
        <canvas id="dayChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS (needed for Modal) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------------- –î–ê–ù–ù–´–ï —Å —Å–µ—Ä–≤–µ—Ä–∞ ---------------- */
const dailyStats = {{ stats.daily | tojson }};
const dailyUserStats = {{ stats.daily_user_counts | tojson }};
const dailyNewUserStats = {{ stats.new_unique_users_per_day | default('[]') | tojson }};
const hourlyDistribution = {{ stats.hourly_distribution | tojson }};
const dayOfWeekDistribution = {{ stats.day_of_week_distribution | tojson }};
// const allUserActivityList = {{ stats.all_user_activity_list | default('[]') | tojson }}; // No longer needed
const currentStartDate = "{{ current_start_date if current_start_date else '' }}";
const currentEndDate = "{{ current_end_date if current_end_date else '' }}";
const chartFont = "'Inter', sans-serif";

const primaryColorAccent = '#0ea5e9'; 
const secondaryColorAccent = '#f43f5e'; 
const tertiaryColorAccent = '#22c55e'; 

const panelTextColor = '#1f2937'; 
const bodyTextColorGlobal = '#e5e7eb';   
const chartGridColorGlobal = 'rgba(255, 255, 255, 0.2)'; 
const chartTickColorGlobal = 'rgba(255, 255, 255, 0.7)'; 
const chartTitleColorGlobal = '#ffffff'; 

/* --------------- –ì—Ä–∞—Ñ–∏–∫ –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ --------------- */
let currentChart;
function renderChart(dailyData, dailyUserData, dailyNewUserData, titleText = '–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫') {
  if (currentChart) currentChart.destroy();
  
  const labels = dailyData.map(item => item[0]);
  const filesData = dailyData.map(item => item[1]);
  const usersData = dailyUserData.map(item => item[1]);
  const newUsersData = dailyNewUserData.map(item => item[1]);

  const datasets = [
    {
      label: '–§–∞–π–ª—ã',
      data: filesData,
      borderColor: primaryColorAccent,
      backgroundColor: 'rgba(14, 165, 233, 0.2)', 
      tension: 0.4, 
      fill: true,
      pointBackgroundColor: primaryColorAccent,
      pointBorderColor: '#fff',
      pointHoverBackgroundColor: '#fff',
      pointHoverBorderColor: primaryColorAccent,
      pointHoverRadius: 7,
      pointHoverBorderWidth: 2,
      pointRadius: 5
    }
  ];

  if (usersData && usersData.length > 0 && usersData.some(u => u > 0)) {
    datasets.push({
      label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', 
      data: usersData,
      borderColor: secondaryColorAccent,
      backgroundColor: 'rgba(244, 63, 94, 0.2)', 
      tension: 0.4,
      fill: true,
      pointBackgroundColor: secondaryColorAccent,
      pointBorderColor: '#fff',
      pointHoverBackgroundColor: '#fff',
      pointHoverBorderColor: secondaryColorAccent,
      pointHoverRadius: 7,
      pointHoverBorderWidth: 2,
      pointRadius: 5
    });
  }

  if (newUsersData && newUsersData.length > 0 && newUsersData.some(u => u > 0)) {
    datasets.push({
      label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
      data: newUsersData,
      borderColor: tertiaryColorAccent, 
      backgroundColor: 'rgba(34, 197, 94, 0.2)',
      tension: 0.4,
      fill: true,
      pointBackgroundColor: tertiaryColorAccent,
      pointBorderColor: '#fff',
      pointHoverBackgroundColor: '#fff',
      pointHoverBorderColor: tertiaryColorAccent,
      pointHoverRadius: 7,
      pointHoverBorderWidth: 2,
      pointRadius: 5,
      yAxisID: 'y' 
    });
  }

  currentChart = new Chart(document.getElementById('dynamicChart'), {
    type: 'line',
    data: { labels: labels, datasets: datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: titleText, font: { size: 18, family: chartFont, weight: '600' }, color: chartTitleColorGlobal, padding: { top:10, bottom: 20 } },
        legend: { position: 'bottom', labels: { font: { family: chartFont, size: 14 }, color: chartTickColorGlobal, usePointStyle: true, pointStyle: 'circle', padding: 20, boxWidth: 8 } },
        tooltip: { backgroundColor: 'rgba(0,0,0,0.7)', titleFont: { family: chartFont, size: 14, weight: '600' }, bodyFont: { family: chartFont, size: 12 }, padding: 12, cornerRadius: 8, displayColors: true, boxPadding: 4 }
      },
      scales: {
        x: { ticks: { font: { family: chartFont, size: 12 }, color: chartTickColorGlobal }, grid: { display: false } },
        y: { type: 'linear', position: 'left', ticks: { font: { family: chartFont, size: 12 }, color: chartTickColorGlobal, padding: 10 }, grid: { color: chartGridColorGlobal, drawBorder: false }, beginAtZero: true }
      },
      layout: { padding: { left: 0, right: 10, top: 0, bottom: 0 } },
      interaction: { intersect: false, mode: 'index' }
    }
  });
}

renderChart(dailyStats, dailyUserStats, dailyNewUserStats, `–î–∏–Ω–∞–º–∏–∫–∞ —Å ${currentStartDate || '–Ω–∞—á–∞–ª–∞'} –ø–æ ${currentEndDate || '–∫–æ–Ω–µ—Ü'}`);

/* --------------- Hourly Activity Chart --------------- */
function renderHourlyActivityChart() {
  const hourlyLabels = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);
  new Chart(document.getElementById('hourlyActivityChart'), {
    type: 'bar',
    data: {
      labels: hourlyLabels,
      datasets: [{
        label: '–§–∞–π–ª–æ–≤ –≤ —á–∞—Å', data: hourlyDistribution,
        backgroundColor: 'rgba(14, 165, 233, 0.6)', borderColor: primaryColorAccent,
        borderWidth: 1, borderRadius: 5, hoverBackgroundColor: 'rgba(14, 165, 233, 0.8)'
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.7)', titleFont: { family: chartFont, size: 13, weight: '600' }, bodyFont: { family: chartFont, size: 11 }, padding: 10, cornerRadius: 6, displayColors: false } },
      scales: { x: { ticks: { font: { family: chartFont, size: 10 }, color: panelTextColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } } }
    }
  });
}

/* --------------- Day-of-Week Activity Chart --------------- */
function renderDayOfWeekActivityChart() {
  const dowLabels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  new Chart(document.getElementById('dayOfWeekActivityChart'), {
    type: 'bar',
    data: {
      labels: dowLabels,
      datasets: [{
        label: '–§–∞–π–ª–æ–≤ –∑–∞ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏', data: dayOfWeekDistribution,
        backgroundColor: 'rgba(244, 63, 94, 0.6)', borderColor: secondaryColorAccent,
        borderWidth: 1, borderRadius: 5, hoverBackgroundColor: 'rgba(244, 63, 94, 0.8)'
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.7)', titleFont: { family: chartFont, size: 13, weight: '600' }, bodyFont: { family: chartFont, size: 11 }, padding: 10, cornerRadius: 6, displayColors: false } },
      scales: { x: { ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } } }
    }
  });
}

if (document.getElementById('hourlyActivityChart')) renderHourlyActivityChart();
if (document.getElementById('dayOfWeekActivityChart')) renderDayOfWeekActivityChart();

/* ----------- User Specific Stats Chart Instances ----------- */
let userDailyTrendChartInstance = null;
let userHourlyActivityChartInstance = null;
let userDayOfWeekActivityChartInstance = null;

/* ----------- Render User Specific Charts ----------- */
function renderUserDailyTrendChart(dailyActivity) {
    if (userDailyTrendChartInstance) userDailyTrendChartInstance.destroy();
    const labels = dailyActivity.map(item => item[0]);
    const data = dailyActivity.map(item => item[1]);
    userDailyTrendChartInstance = new Chart(document.getElementById('userDailyTrendChart'), {
        type: 'line', data: { labels: labels, datasets: [{ label: '–§–∞–π–ª–æ–≤ –≤ –¥–µ–Ω—å', data: data, borderColor: primaryColorAccent, backgroundColor: 'rgba(14, 165, 233, 0.2)', tension: 0.4, fill: true, pointBackgroundColor: primaryColorAccent, pointBorderColor: '#fff' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { font: { family: chartFont, size: 10 }, color: panelTextColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } } } }
    });
}

function renderUserHourlyActivityChart(hourlyData) {
    if (userHourlyActivityChartInstance) userHourlyActivityChartInstance.destroy();
    const hourlyLabels = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);
    userHourlyActivityChartInstance = new Chart(document.getElementById('userHourlyActivityChart'), {
        type: 'bar', data: { labels: hourlyLabels, datasets: [{ label: '–§–∞–π–ª–æ–≤ –≤ —á–∞—Å', data: hourlyData, backgroundColor: 'rgba(14, 165, 233, 0.6)', borderColor: primaryColorAccent, borderWidth: 1, borderRadius: 5 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { font: { family: chartFont, size: 10 }, color: panelTextColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } } } }
    });
}

function renderUserDayOfWeekActivityChart(dowData) {
    if (userDayOfWeekActivityChartInstance) userDayOfWeekActivityChartInstance.destroy();
    const dowLabels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    userDayOfWeekActivityChartInstance = new Chart(document.getElementById('userDayOfWeekActivityChart'), {
        type: 'bar', data: { labels: dowLabels, datasets: [{ label: '–§–∞–π–ª–æ–≤ –∑–∞ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏', data: dowData, backgroundColor: 'rgba(244, 63, 94, 0.6)', borderColor: secondaryColorAccent, borderWidth: 1, borderRadius: 5 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } } } }
    });
}

/* ----------- Fetch and Display User Stats ----------- */
async function fetchAndDisplayUserStats(selectedUserId) { 
    if (!selectedUserId) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."); document.getElementById('userStatsDisplayArea').style.display = 'none'; return; }
    const startDate = document.getElementById('startDateInput').value;
    const endDate = document.getElementById('endDateInput').value;
    let apiUrl = `/api/user_activity/${selectedUserId}`;
    const params = [];
    if (startDate) params.push(`start_date=${startDate}`);
    if (endDate) params.push(`end_date=${endDate}`);
    if (params.length > 0) apiUrl += '?' + params.join('&');

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const userData = await response.json();
        document.getElementById('selectedUserName').textContent = userData.user_id;
        document.getElementById('userTotalFiles').textContent = userData.total_files;
        renderUserDailyTrendChart(userData.daily_activity);
        renderUserHourlyActivityChart(userData.hourly_distribution);
        renderUserDayOfWeekActivityChart(userData.day_of_week_distribution);
        document.getElementById('userStatsDisplayArea').style.display = 'block';
        document.getElementById('userDeepDiveCard').scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error("Could not fetch user stats:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
        document.getElementById('userStatsDisplayArea').style.display = 'none';
    }
}

document.addEventListener('click', function(event) {
    if (event.target.classList.contains('user-link')) {
        event.preventDefault();
        const userId = event.target.dataset.userId;
        if (userId) fetchAndDisplayUserStats(userId);
    }
});

/* ----------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–∞—Ç ----------- */
document.getElementById('applyDateFilterBtn').addEventListener('click', () => {
  const startDate = document.getElementById('startDateInput').value;
  const endDate = document.getElementById('endDateInput').value;
  let url = '/';
  const params = [];
  if (startDate) params.push(`start_date=${startDate}`);
  if (endDate) params.push(`end_date=${endDate}`);
  if (params.length > 0) url += '?' + params.join('&');
  window.location.href = url;
});

function setDatesAndApply(daysAgoStart, daysAgoEnd = 0) {
    const today = new Date();
    const endDate = new Date(today);
    endDate.setDate(today.getDate() - daysAgoEnd);
    document.getElementById('endDateInput').value = endDate.toISOString().slice(0,10);
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - daysAgoStart);
    document.getElementById('startDateInput').value = startDate.toISOString().slice(0,10);
    document.getElementById('applyDateFilterBtn').click();
}

document.getElementById('btnLast7Days').addEventListener('click', () => setDatesAndApply(6));
document.getElementById('btnLast14Days').addEventListener('click', () => setDatesAndApply(13)); 
document.getElementById('btnThisMonth').addEventListener('click', () => {
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    document.getElementById('startDateInput').value = firstDayOfMonth.toISOString().slice(0,10);
    document.getElementById('endDateInput').value = lastDayOfMonth.toISOString().slice(0,10);
    document.getElementById('applyDateFilterBtn').click();
});
document.getElementById('btnAllTime').addEventListener('click', () => {
  document.getElementById('startDateInput').value = '';
  document.getElementById('endDateInput').value = '';
  window.location.href = '/';
});

/* ----------- –ê–≤—Ç–æ-–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (15 –º–∏–Ω) ----------- */
setTimeout(()=>location.reload(), 900000);

/* ---------------- –ì—Ä–∞—Ñ–∏–∫ ¬´24 —á–∞—Å–∞¬ª –≤ –º–æ–¥–∞–ª–∫–µ ---------------- */
let dayChartInstance, dayRefreshTimer=null;
function renderDayChart(hours){
  if(dayChartInstance) dayChartInstance.destroy();
  dayChartInstance = new Chart(document.getElementById('dayChart'),{
    type:'line',
    data:{
      labels:Array.from({length:24},(_,h)=>String(h).padStart(2,'0')+':00'),
      datasets:[{
          label:'–§–∞–π–ª—ã', data:hours, borderColor: primaryColorAccent, backgroundColor: 'rgba(14, 165, 233, 0.2)',
          tension:0.4, fill:true, pointBackgroundColor: primaryColorAccent, pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff', pointHoverBorderColor: primaryColorAccent,
          pointHoverRadius: 6, pointHoverBorderWidth: 2, pointRadius: 4
      }]
    },
    options:{
        responsive:true, maintainAspectRatio: false,
        plugins:{
            title:{display:true,text:'üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º',font:{size:16, family: chartFont, weight: '600' }, color: panelTextColor, padding: {bottom: 15}}, 
            legend: { display: false },
            tooltip: { backgroundColor: 'rgba(0,0,0,0.7)', titleFont: { family: chartFont, size: 13, weight: '600' }, bodyFont: { family: chartFont, size: 11 }, padding: 10, cornerRadius: 6, displayColors: false }
        },
        scales:{
            y:{beginAtZero:true, ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { color: 'rgba(0,0,0,0.08)', drawBorder: false }}, 
            x:{ticks: { font: { family: chartFont, size: 11 }, color: panelTextColor }, grid: { display: false }}
        },
        interaction: { intersect: false, mode: 'index' }
    }
  });
}

function refreshDayChart(date){
  fetch('/day/'+date).then(r=>r.json()).then(d=>{ if (dayChartInstance && d.hourly) { dayChartInstance.data.datasets[0].data = d.hourly; dayChartInstance.update(); }});
}
document.querySelectorAll('.date-link').forEach(el=>{
  el.addEventListener('click',e=>{
    e.preventDefault(); const date = el.dataset.date;
    fetch('/day/'+date).then(r=>r.json()).then(d=>{
      if (d.error) { console.error("Error fetching day detail:", d.error); return; }
      document.getElementById('modalDate').textContent = date; renderDayChart(d.hourly);
      if(date === new Date().toISOString().slice(0,10)){ if(dayRefreshTimer) clearInterval(dayRefreshTimer); dayRefreshTimer = setInterval(()=>refreshDayChart(date), 60000); } else { if(dayRefreshTimer) clearInterval(dayRefreshTimer); }
      let dayModalElement = document.getElementById('dayModal'); let modalInstance = bootstrap.Modal.getInstance(dayModalElement); if (!modalInstance) { modalInstance = new bootstrap.Modal(dayModalElement); } modalInstance.show();
    });
  });
});
document.getElementById('dayModal').addEventListener('hidden.bs.modal',()=>{ if(dayRefreshTimer){ clearInterval(dayRefreshTimer); dayRefreshTimer=null; }});
setInterval(()=>{ fetch('/server_time').then(r=>r.json()).then(d=>{ const srvTimeEl = document.getElementById('srvTime'); if (srvTimeEl) srvTimeEl.textContent = d.now; }); },60000);
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

@keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

:root {
  /* Glassmorphism Palette */
  --glass-bg: rgba(255, 255, 255, 0.1); 
  --glass-border-color: rgba(255, 255, 255, 0.2); 
  --glass-shadow: 0 5px 20px rgba(0, 0, 0, 0.15); 
  --glass-blur: 8px; 

  /* Text & Accent Colors for Glassmorphism */
  --text-color-on-dark-bg: #e0e5ec; 
  --text-color-on-glass: #2c3e50;  
  --text-light-on-glass: #566573; 
  
  --primary-color-accent: #0ea5e9; 
  --secondary-color-accent: #f43f5e; 
  --tertiary-color-accent: #22c55e; 

  --chart-title-color-global: #f0f4f8; 
  --chart-tick-color-global: rgba(230, 235, 240, 0.75); 
  --chart-grid-color-global: rgba(230, 235, 240, 0.15); 

  /* General Layout & Sizing */
  --neo-radius: 16px; 
  --neo-padding: 20px; 
}

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(120deg, #2c3e50 0%, #34495e 50%, #4ca1af 100%);
  background-size: 200% 200%; /* Adjusted for smoother animation */
  animation: gradientBG 25s ease infinite;
  color: var(--text-color-on-dark-bg); 
  margin: 0;
  padding: 20px; 
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  min-height: 100vh;
}

.dashboard-container { display: flex; flex-direction: column; gap: 25px; max-width: 1600px; margin: auto; }
.dashboard-header { text-align: center; padding: 10px 0; margin-bottom: 10px; }
.dashboard-header h1 { font-size: 2.2em; font-weight: 700; color: var(--text-color-on-dark-bg); margin-bottom: 0.2em; }
.server-time { font-size: 0.95em; color: var(--text-color-on-dark-bg); opacity: 0.8; }

.neo-card { 
  background-color: var(--glass-bg);
  border-radius: var(--neo-radius);
  padding: var(--neo-padding);
  border: 1px solid var(--glass-border-color);
  box-shadow: var(--glass-shadow);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  transition: box-shadow 0.3s ease, background-color 0.3s ease;
}
.neo-card-title { font-size: 1.4em; font-weight: 600; color: var(--text-color-on-glass); margin-bottom: 20px; text-align: center; }

.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--neo-padding); }
.kpi-item {
  text-align: center; padding: 20px; 
  background-color: rgba(255, 255, 255, 0.07); 
  border-radius: calc(var(--neo-radius) - 6px); 
  border: 1px solid rgba(255,255,255,0.15);
}
.kpi-item h2 { font-size: 1em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light-on-glass); margin-bottom: 8px; font-weight: 500; }
.kpi-item p { font-size: 2em; font-weight: 700; color: var(--primary-color-accent); margin: 0; }

.date-filters .filter-controls { display: flex; flex-wrap: wrap; gap: 15px 20px; align-items: flex-end; justify-content: center; }
.filter-group { display: flex; flex-direction: column; flex-grow: 1; min-width: 180px; }
.filter-group label { font-size: 0.85em; color: var(--text-light-on-glass); margin-bottom: 6px; font-weight: 500; }
.filter-buttons { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; padding-top: 22px; }

.neo-input, .neo-button {
  background-color: rgba(255, 255, 255, 0.08); 
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: var(--text-color-on-dark-bg); 
  border-radius: 8px; 
  padding: 10px 16px; 
  font-size: 0.95em;
  font-family: 'Inter', sans-serif;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
  transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
  outline: none;
}
.neo-input { width: 100%; box-sizing: border-box; }
.neo-input:focus {
  background-color: rgba(255, 255, 255, 0.15);
  border-color: var(--primary-color-accent);
  box-shadow: 0 0 0 2px var(--primary-color-accent); 
}
.neo-button {
  font-weight: 500; cursor: pointer;
}
.neo-button:hover {
  background-color: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.3);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
  color: #fff;
}
.neo-button:active {
  background-color: rgba(255, 255, 255, 0.05);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
  transform: translateY(1px); 
  color: rgba(255,255,255,0.9);
}
.neo-button.export-button { 
    background-color: rgba(34, 197, 94, 0.5); 
    border-color: rgba(34, 197, 94, 0.7);
    color: white;
}
.neo-button.export-button:hover {
    background-color: rgba(34, 197, 94, 0.7);
    border-color: rgba(34, 197, 94, 0.9);
    color: white;
}

.chart-container { height: 480px; padding: var(--neo-padding); }
#dynamicChart { width: 100% !important; height: 100% !important; }
.activity-patterns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--neo-padding); }
#hourlyActivityChart, #dayOfWeekActivityChart { width: 100% !important; height: 100% !important; }

.tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--neo-padding); }
.table-responsive {
  overflow-x: auto; border-radius: calc(var(--neo-radius) - 4px); padding: 10px; 
  background-color: rgba(255,255,255,0.03); 
  border: 1px solid rgba(255,255,255,0.1);
}
.neo-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9em; }
.neo-table th, .neo-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--glass-border-color); }
.neo-table th:first-child, .neo-table td:first-child { padding-left: 20px; }
.neo-table th:last-child, .neo-table td:last-child { padding-right: 20px; }
.neo-table thead tr { background-color: transparent; }
.neo-table th { font-weight: 600; color: var(--text-light-on-glass); text-align: center; border-bottom-width: 1px; }
.neo-table td { text-align: center; color: var(--text-color-on-glass); }
.neo-table tbody tr:last-child td { border-bottom: none; }
.neo-table tbody tr:hover { background-color: rgba(255,255,255,0.05); }
.neo-link { color: var(--primary-color-accent); text-decoration: none; font-weight: 500; }
.neo-link:hover { color: #38bdf8; text-decoration: underline; }

.dashboard-footer { text-align: center; padding-top: 20px; }

.modal-backdrop.show { background-color: rgba(10, 20, 30, 0.3); backdrop-filter: blur(4px); opacity: 1; }
.modal-dialog { max-width: 800px; }
.modal-content-neo { /* Uses .neo-card styling */ }
.modal-header-neo { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border-color); margin-bottom: 20px; }
.modal-title-neo { font-size: 1.5em; font-weight: 600; color: var(--text-color-on-glass); }
.neo-close-button { background: transparent; border: none; font-size: 2.2em; line-height: 1; color: var(--text-light-on-glass); cursor: pointer; padding: 0 5px; opacity: 0.8; transition: all 0.2s; border-radius: 8px; }
.neo-close-button:hover { opacity: 1; color: var(--primary-color-accent); background-color: rgba(255,255,255,0.05); }
.modal-body-neo { padding: 0; height: 400px; }
#dayChart { width: 100% !important; height: 100% !important; }

.user-select-controls { display: flex; flex-wrap: wrap; gap: 15px 20px; align-items: flex-end; margin-bottom: 20px; }
.user-select-controls .filter-group { margin-bottom: 0; }
.user-select-controls .neo-input { min-width: 250px; }
.user-kpi { font-size: 1.1em; text-align: center; margin: 15px 0; color: var(--text-color-on-glass); }
.user-kpi strong { color: var(--primary-color-accent); font-weight: 600; }
.user-charts-grid { display: grid; grid-template-columns: 1fr; gap: var(--neo-padding); }
#userDailyTrendChart, #userHourlyActivityChart, #userDayOfWeekActivityChart { width: 100% !important; height: 100% !important; }
.neo-card-header { padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border-color); text-align: center; }
.neo-card-header h4 { margin: 0; font-size: 1.2em; font-weight: 600; color: var(--text-color-on-glass); }
.neo-card-body {}
.chart-body-fixed-height { height: 320px; }

.activity-patterns-grid .neo-card-header h4,
#userDeepDiveCard .neo-card-header h4,
#userDeepDiveCard .neo-card-header h5 { color: var(--text-color-on-glass); }

/* Responsiveness */
@media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } }
@media (max-width: 992px) {
  .user-charts-grid, .activity-patterns-grid, .tables-grid { grid-template-columns: 1fr; }
  .date-filters .filter-controls { flex-direction: column; align-items: stretch; }
  .filter-buttons { justify-content: flex-start; padding-top: 10px; }
  .filter-buttons .neo-button { flex-grow: 1; }
  .dashboard-header h1 { font-size: 1.9em; }
}
@media (max-width: 768px) {
  body { padding: 15px; } .dashboard-container { gap: 20px; }
  :root { --neo-radius: 14px; --neo-padding: 15px; } 
  .neo-card-title { font-size: 1.2em; } .kpi-item p { font-size: 1.7em; }
  .neo-button, .neo-input { padding: 10px 14px; font-size: 0.85em; border-radius: 6px;}
  .filter-buttons { flex-direction: row; }
  .filter-buttons .neo-button { flex-basis: calc(50% - 5px); }
  .modal-dialog { margin: 10px; max-width: calc(100% - 20px); }
  .modal-body-neo { height: 300px; } .dashboard-header h1 { font-size: 1.6em; }
  .chart-body-fixed-height { height: 280px; }
}
@media (max-width: 480px) {
    .dashboard-header h1 { font-size: 1.3em; }
    :root { --neo-radius: 10px; --neo-padding: 12px; }
    .kpi-grid { grid-template-columns: 1fr; }
    .filter-buttons .neo-button { flex-basis: 100%; }
    .neo-table { font-size: 0.8em; } .neo-table th, .neo-table td { padding: 8px 10px; }
    .chart-container { height: 320px; } .chart-body-fixed-height { height: 260px; } 
    .user-charts-grid .chart-body-fixed-height { height: 240px; } 
    .modal-body-neo { height: 260px; }
}
@media (min-width: 993px) { .user-charts-grid { grid-template-columns: repeat(3, 1fr); } }

</style>
</body>
</html>
